name: Sync master to team branches (rebase-first)

on:
  push:
    branches: [ master ]               # master更新時に発火
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: sync-master-to-teams
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        team_branch: [Team_A, Team_B, Team_C]   # 対象ブランチを列挙
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Git identity
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Fetch
        run: |
          git fetch --prune origin
          git checkout ${{ matrix.team_branch }}
          # 念のため、リモートの状態に合わせる（ローカル汚染防止）
          git reset --hard origin/${{ matrix.team_branch }}

      # === ここが肝 ===
      # mergeではなくrebase。成功すればマージコミットは一切出ない
      - name: Rebase team branch onto master
        id: rebase
        run: |
          set -e
          git rebase origin/master || echo "need_pr=true" >> "$GITHUB_OUTPUT"

      - name: Push (force-with-lease) if rebase succeeded
        if: steps.rebase.outputs.need_pr != 'true'
        run: |
          # 直線履歴維持。branch protectionでforce禁止ならこの方法は使えない
          git push origin HEAD:${{ matrix.team_branch }} --force-with-lease

      # 競合が出たときだけ、手動解決用のPRを作る（このときだけ最終的にmergeコミットが生じ得る）
      - name: Abort rebase if conflicted
        if: steps.rebase.outputs.need_pr == 'true'
        run: |
          git rebase --abort || true

      - name: Create PR for conflict resolution
        if: steps.rebase.outputs.need_pr == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          title: "Sync master → ${{ matrix.team_branch }}（競合解消が必要）"
          commit-message: "chore(sync): prepare conflict resolution for ${{ matrix.team_branch }}"
          body: |
            `master` の更新を `${{ matrix.team_branch }}` に取り込む際に競合が発生しました。
            このPR上で解消してください（解消後はマージコミットが1つだけ生じます）。
          branch: "automation/sync-master-into-${{ matrix.team_branch }}"
          base: "${{ matrix.team_branch }}"
          labels: "sync, needs-conflict-resolution"
